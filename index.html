<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ—¥èªŒç®¡1ç†ç³»çµ± - Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --accent: #f59e0b;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .input-group:focus-within label {
            color: var(--primary);
        }

        /* ä¿®æ­£è·‘ç‰ˆçš„æ ¸å¿ƒæ¨£å¼ */
        input, select, textarea {
            width: 100%; /* å¼·åˆ¶æ»¿å¯¬é˜²æ­¢è·‘ç‰ˆ */
            background: rgba(248, 250, 252, 0.8);
            border: 1.5px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: block;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        .tab-btn {
            position: relative;
            padding-bottom: 0.75rem;
            color: #64748b;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--primary);
            font-weight: 700;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary);
            border-radius: 99px;
            animation: tab-slide 0.3s ease;
        }

        @keyframes tab-slide {
            from { width: 0; opacity: 0; }
            to { width: 100%; opacity: 1; }
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -4px rgba(37, 99, 235, 0.4);
        }

        .preview-content {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="p-4 md:p-8 lg:p-10">

    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <header class="mb-10 flex flex-col items-center">
            <div class="bg-blue-600 p-3 rounded-2xl shadow-xl mb-4">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            <h1 class="text-3xl md:text-4xl font-black text-slate-800 tracking-tight text-center">å·¥ä½œæ—¥èªŒç®¡ç†ç³»çµ±</h1>
            <p class="text-slate-500 mt-2 font-medium">é«˜æ•ˆç®¡ç†ã€ç²¾æº–çµ±è¨ˆã€å³æ™‚åŒæ­¥</p>
            
            <nav class="flex mt-8 space-x-12 border-b border-slate-200 w-full max-w-md justify-center">
                <button onclick="switchTab('input')" id="tab-input" class="tab-btn active text-lg">æ—¥èªŒç·¨å¯«</button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn text-lg">æ•¸æ“šä¸­å¿ƒ</button>
            </nav>
        </header>

        <!-- é é¢ 1: æ—¥èªŒè¼¸å…¥ -->
        <main id="page-input" class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- Form Section -->
            <section class="lg:col-span-6 xl:col-span-5 w-full">
                <form id="workLogForm" class="glass-panel p-6 md:p-8 space-y-5">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-xl md:text-2xl font-bold text-slate-800">æ–°æ—¥èªŒç´€éŒ„</h2>
                        <span class="px-2 py-1 bg-blue-50 text-blue-600 text-[10px] font-bold rounded-full uppercase tracking-wider">Cloud Ready</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-slate-600">ä¸»è¦é™¢å€</label>
                            <select id="campus" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="æ°¸åº·">ğŸ¥ æ°¸åº·</option>
                                <option value="æŸ³ç‡Ÿ">ğŸ¥ æŸ³ç‡Ÿ</option>
                                <option value="ä½³é‡Œ">ğŸ¥ ä½³é‡Œ</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-slate-600">åæ‡‰å–®ä½</label>
                            <select id="department" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="è­·ç†éƒ¨">è­·ç†éƒ¨</option>
                                <option value="é–‹åˆ€æˆ¿">é–‹åˆ€æˆ¿</option>
                                <option value="å‡ºé™¢æº–å‚™">å‡ºé™¢æº–å‚™</option>
                                <option value="ç‡Ÿé¤Šç§‘">ç‡Ÿé¤Šç§‘</option>
                                <option value="æ…¢ç®¡ä¸­å¿ƒ">æ…¢ç®¡ä¸­å¿ƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-slate-600">ç”³è«‹å–®è™Ÿ</label>
                            <input type="text" id="orderNo" placeholder="å¦‚ï¼šORD101">
                        </div>
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-slate-600">åæ‡‰äººå“¡</label>
                            <input type="text" id="staffName" required placeholder="æ‚¨çš„å§“å">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="block mb-1.5 text-sm font-bold text-slate-600">ç›¸é—œç¨‹å¼</label>
                        <select id="program">
                            <option value="">è«‹é¸æ“‡ç›¸é—œç³»çµ±ç¨‹å¼</option>
                            <option value="ipo88100[è­·ç†ç—…æ­·ç€è¦½]">ipo88100[è­·ç†ç—…æ­·ç€è¦½]</option>
                            <option value="sugar[ç³–å°¿ç—…å“è³ªæ–¹æ¡ˆç…§è­·]">sugar[ç³–å°¿ç—…å“è³ªæ–¹æ¡ˆç…§è­·]</option>
                            <option value="opd734b[pre-ESRDå€‹æ¡ˆç®¡ç†]">opd734b[pre-ESRDå€‹æ¡ˆç®¡ç†]</option>
                            <option value="inh0640[ä½å‡ºé™¢é£²é£ŸæŸ¥è©¢]">inh0640[ä½å‡ºé™¢é£²é£ŸæŸ¥è©¢]</option>
                        </select>
                    </div>

                    <div class="p-4 bg-slate-50/50 rounded-2xl border border-slate-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="input-group">
                                <label class="text-xs font-bold text-slate-400 mb-1 block">ç—…æ­·è™Ÿ</label>
                                <input type="text" id="chartNo" class="bg-white" placeholder="ç—…æ­·ç·¨è™Ÿ">
                            </div>
                            <div class="input-group">
                                <label class="text-xs font-bold text-slate-400 mb-1 block">ç—…äººå§“å</label>
                                <input type="text" id="patientName" class="bg-white" placeholder="ç—…æ‚£å§“å">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-blue-700">å•é¡Œæè¿°</label>
                            <textarea id="desc_problem" rows="3" placeholder="è©³ç´°æè¿°ç™¼ç”Ÿçš„å•é¡Œèˆ‡æµç¨‹..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="block mb-1.5 text-sm font-bold text-emerald-700">è™•ç†çµæœ</label>
                            <textarea id="desc_result" rows="2" placeholder="ç›®å‰é€²åº¦æˆ–æœ€çµ‚è™•ç†çµæœ..."></textarea>
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="btn-primary w-full text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 disabled:opacity-50 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        <span>å„²å­˜æ—¥èªŒ</span>
                    </button>
                </form>
            </section>

            <!-- Preview Section -->
            <section class="lg:col-span-6 xl:col-span-7 space-y-6">
                <div class="glass-panel p-6 md:p-8 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-6 relative">
                        <h2 class="text-lg font-bold text-amber-900 flex items-center">
                            <span class="w-1.5 h-5 bg-amber-500 rounded-full mr-3"></span>
                            å…§å®¹å³æ™‚é è¦½
                        </h2>
                        <button onclick="copyPreview()" class="bg-amber-100 text-amber-700 font-bold px-4 py-1.5 rounded-lg text-xs hover:bg-amber-200 transition-colors">
                            è¤‡è£½å…§å®¹
                        </button>
                    </div>
                    <div class="preview-content bg-white p-6 rounded-xl border border-amber-100 min-h-[200px] shadow-inner text-slate-700 text-sm leading-relaxed">
                        <div id="textPreview" class="whitespace-pre-wrap font-mono"></div>
                    </div>
                </div>

                <!-- æœ€è¿‘ç´€éŒ„ -->
                <div class="glass-panel p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h2 class="text-lg font-bold text-slate-800">æœ€è¿‘è™•ç†ç´€éŒ„</h2>
                        <button onclick="exportToCSV()" class="text-blue-600 text-xs font-bold hover:underline">åŒ¯å‡º CSV</button>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 text-slate-400 text-xs uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">æ™‚é–“</th>
                                    <th class="px-4 py-3 text-left">å–®ä½</th>
                                    <th class="px-4 py-3 text-left">äººå“¡</th>
                                    <th class="px-4 py-3 text-right"></th>
                                </tr>
                            </thead>
                            <tbody id="logList" class="divide-y divide-slate-100 bg-white">
                                <!-- Data rows -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>

        <!-- é é¢ 2: å„€è¡¨æ¿ (ä¿æŒä¸è®Šä½†å„ªåŒ–ä½ˆå±€) -->
        <main id="page-dashboard" class="hidden animate-in fade-in duration-500">
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
                <h2 class="text-2xl font-bold text-slate-800">æ•¸æ“šåˆ†æä¸­å¿ƒ</h2>
                <button onclick="fetchLatestData()" class="px-5 py-2 bg-white border border-slate-200 rounded-lg shadow-sm font-bold text-sm text-slate-600 hover:bg-slate-50 flex items-center transition-all">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    åˆ·æ–°é›²ç«¯æ•¸æ“š
                </button>
            </div>

            <!-- KPI Row -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-5 border-l-4 border-blue-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ç´¯ç©æ—¥èªŒ</p>
                    <h3 id="dash-total" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                </div>
                <div class="glass-panel p-5 border-l-4 border-emerald-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ä»Šæ—¥æ–°å¢</p>
                    <h3 id="dash-today" class="text-3xl font-black text-slate-800 mt-1">0</h3>
                </div>
                <div class="glass-panel p-5 border-l-4 border-amber-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ç†±é–€é™¢å€</p>
                    <h3 id="dash-peak-campus" class="text-xl font-bold text-slate-700 mt-2">--</h3>
                </div>
                <div class="glass-panel p-5 border-l-4 border-purple-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ä¸»è¦å–®ä½</p>
                    <h3 id="dash-peak-dept" class="text-xl font-bold text-slate-700 mt-2 truncate">--</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 h-[400px] flex flex-col">
                    <h4 class="text-sm font-bold text-slate-800 mb-6 flex items-center">é™¢å€ä½”æ¯”åˆ†æ</h4>
                    <div class="flex-grow relative"><canvas id="chartCampus"></canvas></div>
                </div>
                <div class="glass-panel p-6 h-[400px] flex flex-col">
                    <h4 class="text-sm font-bold text-slate-800 mb-6 flex items-center">åæ‡‰å–®ä½åˆ†å¸ƒ</h4>
                    <div class="flex-grow relative"><canvas id="chartDept"></canvas></div>
                </div>
                <div class="glass-panel p-6 h-[450px] lg:col-span-2 flex flex-col">
                    <h4 class="text-sm font-bold text-slate-800 mb-6 flex items-center">äººå“¡å·¥ä½œè² è·æ’è¡Œ</h4>
                    <div class="flex-grow relative"><canvas id="chartStaff"></canvas></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading & Notification UI åŒä¸Šç‰ˆæœ¬ -->
    <div id="loading" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-bold text-slate-700">åŒæ­¥ä¸­...</p>
        </div>
    </div>

    <div id="notification" class="fixed top-6 left-1/2 -translate-x-1/2 hidden z-[110] transform transition-all">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-xl shadow-xl font-bold flex items-center space-x-2">
            <span id="notif-icon"></span>
            <span id="notif-text"></span>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyl3vNhh_Uo6D2kSwoE47cFjMBrPmQlc5k_JyK4rL3Xb-YYF1ySBWx2qkevXLZMAdJGgw/exec";
        let logs = JSON.parse(localStorage.getItem('workLogs_v4')) || [];
        let charts = {};

        function switchTab(tab) {
            const isInput = tab === 'input';
            document.getElementById('page-input').classList.toggle('hidden', !isInput);
            document.getElementById('page-dashboard').classList.toggle('hidden', isInput);
            document.getElementById('tab-input').classList.toggle('active', isInput);
            document.getElementById('tab-dashboard').classList.toggle('active', !isInput);
            if (!isInput) fetchLatestData();
        }

        async function fetchLatestData() {
            const loader = document.getElementById('loading');
            loader.classList.remove('hidden');
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getData`);
                const data = await response.json();
                if (data && Array.isArray(data)) {
                    logs = data;
                    localStorage.setItem('workLogs_v4', JSON.stringify(logs));
                    updateDashboardUI();
                    renderLogList();
                }
            } catch (err) {
                console.warn('Using cache');
                updateDashboardUI();
            } finally {
                setTimeout(() => loader.classList.add('hidden'), 500);
            }
        }

        const form = document.getElementById('workLogForm');
        form.addEventListener('input', updatePreview);

        function updatePreview() {
            const d = {
                campus: document.getElementById('campus').value,
                dept: document.getElementById('department').value,
                staff: document.getElementById('staffName').value,
                prog: document.getElementById('program').value,
                prob: document.getElementById('desc_problem').value,
                res: document.getElementById('desc_result').value
            };
            
            const preview = `ğŸ“ ã€å·¥ä½œæ—¥èªŒæ‘˜è¦ã€‘\n` +
                            `ğŸ“ é™¢å€å–®ä½ï¼š${d.campus || '--'} / ${d.dept || '--'}\n` +
                            `ğŸ‘¤ è™•ç†äººå“¡ï¼š${d.staff || '--'}\n` +
                            `ğŸ’» ç›¸é—œç³»çµ±ï¼š${d.prog || '--'}\n\n` +
                            `[å•é¡Œæè¿°]ï¼š\n${d.prob || 'è«‹å¡«å¯«æè¿°...'}\n\n` +
                            `[è™•ç†çµæœ]ï¼š\n${d.res || 'é€²è¡Œä¸­...'}`;
            
            document.getElementById('textPreview').innerText = preview;
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-pulse">ä¸Šå‚³ä¸­...</span>`;

            const payload = {
                campus: document.getElementById('campus').value,
                department: document.getElementById('department').value,
                orderNo: document.getElementById('orderNo').value,
                staffName: document.getElementById('staffName').value,
                program: document.getElementById('program').value,
                chartNo: document.getElementById('chartNo').value,
                patientName: document.getElementById('patientName').value,
                desc_problem: document.getElementById('desc_problem').value,
                desc_result: document.getElementById('desc_result').value,
                timestamp: new Date().toISOString()
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                const newEntry = { ...payload, dateStr: new Date().toLocaleString(), id: Date.now() };
                logs.unshift(newEntry);
                localStorage.setItem('workLogs_v4', JSON.stringify(logs));
                
                showNotification('âœ… å·²å„²å­˜');
                form.reset();
                renderLogList();
                updatePreview();
            } catch (err) {
                showNotification('âŒ é€£ç·šéŒ¯èª¤', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>å„²å­˜æ—¥èªŒ</span>`;
            }
        });

        function updateDashboardUI() {
            const total = logs.length;
            const todayStr = new Date().toLocaleDateString();
            const todayLogs = logs.filter(l => new Date(l.timestamp || l.dateStr).toLocaleDateString() === todayStr).length;

            document.getElementById('dash-total').innerText = total;
            document.getElementById('dash-today').innerText = todayLogs;

            if (total === 0) return;

            const counts = { campus: {}, dept: {}, staff: {} };
            logs.forEach(l => {
                counts.campus[l.campus] = (counts.campus[l.campus] || 0) + 1;
                counts.dept[l.department] = (counts.dept[l.department] || 0) + 1;
                counts.staff[l.staffName] = (counts.staff[l.staffName] || 0) + 1;
            });

            document.getElementById('dash-peak-campus').innerText = Object.entries(counts.campus).sort((a,b)=>b[1]-a[1])[0]?.[0] || '--';
            document.getElementById('dash-peak-dept').innerText = Object.entries(counts.dept).sort((a,b)=>b[1]-a[1])[0]?.[0] || '--';

            initChart('chartCampus', 'pie', Object.keys(counts.campus), Object.values(counts.campus), ['#3b82f6', '#f59e0b', '#10b981', '#ef4444']);
            initChart('chartDept', 'doughnut', Object.keys(counts.dept), Object.values(counts.dept), ['#8b5cf6', '#ec4899', '#f97316', '#06b6d4', '#64748b']);
            const sortedStaff = Object.entries(counts.staff).sort((a,b)=>b[1]-a[1]).slice(0, 10);
            initChart('chartStaff', 'bar', sortedStaff.map(s => s[0]), sortedStaff.map(s => s[1]), '#3b82f6');
        }

        function initChart(id, type, labels, data, colors) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'white',
                        borderWidth: 2,
                        borderRadius: type === 'bar' ? 6 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: type !== 'bar', position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        }

        function renderLogList() {
            const container = document.getElementById('logList');
            container.innerHTML = logs.slice(0, 5).map(l => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-4 py-3 text-[10px] text-slate-400 font-medium">${new Date(l.timestamp || l.dateStr).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    <td class="px-4 py-3">
                        <div class="font-bold text-slate-700 text-xs">${l.campus}</div>
                        <div class="text-[9px] text-slate-400">${l.department}</div>
                    </td>
                    <td class="px-4 py-3 text-slate-600 text-xs">${l.staffName}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-slate-300 hover:text-red-500 transition-colors">ğŸ—‘ï¸</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="py-10 text-center text-slate-300 italic">å°šæœªæœ‰ç´€éŒ„</td></tr>';
        }

        function showNotification(msg, isError = false) {
            const n = document.getElementById('notification');
            const text = document.getElementById('notif-text');
            text.innerText = msg;
            n.classList.remove('hidden');
            setTimeout(() => n.classList.add('hidden'), 3000);
        }

        function copyPreview() {
            const text = document.getElementById('textPreview').innerText;
            navigator.clipboard.writeText(text);
            showNotification('ğŸ“‹ å·²è¤‡è£½');
        }

        function exportToCSV() {
            if (logs.length === 0) return;
            let csv = "\uFEFFæ™‚é–“,é™¢å€,å–®ä½,å–®è™Ÿ,äººå“¡,ç¨‹å¼,ç—…æ­·è™Ÿ,å§“å,å•é¡Œæè¿°,çµæœ\n";
            logs.forEach(l => {
                csv += `"${l.timestamp || l.dateStr}","${l.campus}","${l.department}","${l.orderNo}","${l.staffName}","${l.program}","${l.chartNo}","${l.patientName}","${l.desc_problem.replace(/\n/g, ' ')}","${l.desc_result.replace(/\n/g, ' ')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `WorkLog_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        renderLogList();
        updatePreview();
        updateDashboardUI();
    </script>
</body>
</html>
